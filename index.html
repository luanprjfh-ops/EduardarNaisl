<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agendamentos Online</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#0F0029; --bg2:#1E0040; --p3:#4E0061;
      --neon2:#BC0DD9; --blue1:#3D5BB6;
      --text:#F3EFFF; --muted:#C9B8FF;
      --card: rgba(255,255,255,0.06); --stroke: rgba(255,255,255,0.10);
    }
    body{
      margin:0; color:var(--text); font-family: Inter, system-ui, Arial;
      background:
        radial-gradient(900px 500px at 15% 25%, rgba(188,13,217,0.18), transparent 60%),
        radial-gradient(900px 500px at 70% 55%, rgba(61,91,182,0.18), transparent 60%),
        linear-gradient(135deg, var(--bg0), var(--bg2), var(--p3));
      min-height:100vh;
    }

    .wrap{max-width:980px;margin:0 auto;padding:22px;}
    .title{font-weight:900;font-size:32px;letter-spacing:.2px}
    .sub{color:rgba(255,255,255,.75);margin-top:6px}

    /* HERO / MENSAGEM PRINCIPAL */
    .hero{
      margin-top:18px;
      margin-bottom:20px;
      padding:22px;
      border-radius:22px;
      background: linear-gradient(135deg, rgba(188,13,217,0.22), rgba(61,91,182,0.22));
      border:1px solid rgba(255,255,255,0.18);
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      backdrop-filter: blur(14px);
      position: relative;
      overflow: hidden;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(420px 220px at 80% 10%, rgba(255,255,255,0.12), transparent 60%);
      pointer-events:none;
    }
    .hero h2{
      margin:0;
      font-size:24px;
      font-weight:950;
      letter-spacing:.3px;
    }
    .hero p{
      margin-top:10px;
      font-size:14px;
      line-height:1.6;
      color:rgba(255,255,255,0.88);
      max-width:820px;
    }
    .hero .steps{
      display:flex;
      gap:14px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .step{
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:14px;
      padding:10px 14px;
      font-size:12px;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
    }

    /* LISTA */
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.45);
      padding:14px 16px;
    }
    .list{margin-top:16px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{
      border:1px solid rgba(61,91,182,0.5);
      background: rgba(61,91,182,0.12);
      padding:6px 10px; border-radius:999px; font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .price{font-weight:900;font-size:18px}
    .hint{margin-top:10px;color:rgba(255,255,255,.6);font-size:12px}

    /* BOT√ïES */
    .btn{
      cursor:pointer; border:1px solid rgba(255,255,255,.16);
      background: rgba(188,13,217,0.14);
      color: var(--text);
      border-radius: 14px; padding:10px 12px; font-weight:850;
      transition: transform .05s ease, filter .12s ease;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px); }
    .btn.ghost{ background: rgba(255,255,255,0.06); }

    /* MODAL */
    .backdrop{
      position:fixed; inset:0; background: rgba(0,0,0,0.55);
      display:none; align-items:center; justify-content:center; padding:18px;
    }
    .modal{
      width:min(560px, 100%);
      background: rgba(0,0,0,0.30);
      border:1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(18px);
      box-shadow: 0 20px 80px rgba(0,0,0,0.60);
      border-radius: 20px;
      padding: 16px;
    }
    .mhead{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .mh1{font-weight:950;font-size:18px}
    .mh2{color:rgba(255,255,255,.7); font-size:13px; margin-top:4px; line-height:1.3}
    .x{
      cursor:pointer; border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px; padding:8px 10px; font-weight:900;
    }
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }

    label{display:block; font-size:12px; color:rgba(255,255,255,.75); margin-bottom:6px}
    input, select{
      width:100%;
      box-sizing:border-box;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.14);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.45)}
    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .muted{color:rgba(255,255,255,.7); font-size:12px}

    /* WHATSAPP */
    .whatsapp-float{
      position:fixed;
      right:18px;
      bottom:18px;
      z-index:999;
    }
    .whatsapp-btn{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(37,211,102,0.95), rgba(30,190,87,0.95));
      color:#072113;
      font-weight:950;
      font-size:13px;
      border:1px solid rgba(255,255,255,0.16);
      cursor:pointer;
      box-shadow: 0 18px 55px rgba(0,0,0,0.50);
      text-decoration:none;
      backdrop-filter: blur(10px);
    }
    .whatsapp-btn:hover{ filter:brightness(1.06); }
    .whatsapp-btn span{ color:#ffffff; }
    .wa-ico{
      width:24px;height:24px; display:inline-flex; align-items:center; justify-content:center;
    }

    footer{
      margin-top:18px;
      padding:14px 0 4px;
      color:rgba(255,255,255,.65);
      font-size:12px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">Agendamentos Online</div>
    <div class="sub">Escolha um hor√°rio dispon√≠vel e envie seu pedido</div>

    <div class="hero">
      <h2>‚ú® Agende seu hor√°rio com praticidade e eleg√¢ncia</h2>
      <p>
        Nossos servi√ßos de unhas unem t√©cnica, higiene e produtos de alta qualidade para um resultado impec√°vel e duradouro.
        Escolha o servi√ßo, selecione o hor√°rio dispon√≠vel e garanta seu momento de cuidado e beleza.
      </p>
      <div class="steps">
        <div class="step">üíÖ Escolha o servi√ßo</div>
        <div class="step">üìÖ Selecione o hor√°rio</div>
        <div class="step">üì≤ Envie o pedido</div>
      </div>
    </div>

    <div class="list" id="list"></div>
    <div class="hint">Os hor√°rios aparecem aqui quando forem cadastrados no painel e marcados como ‚ÄúPublicar‚Äù.</div>

    <footer>Direitos reservado LEP-Sistemas e automa√ß√£o empresarial</footer>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal">
      <div class="mhead">
        <div>
          <div class="mh1">Confirmar agendamento</div>
          <div class="mh2" id="m_info">‚Äî</div>
        </div>
        <button class="x" id="m_close">Fechar</button>
      </div>

      <div class="grid">
        <div>
          <label>Seu nome</label>
          <input id="m_name" placeholder="Ex: Maria Silva"/>
        </div>
        <div>
          <label>WhatsApp / Telefone</label>
          <input id="m_phone" placeholder="(DDD) 99999-9999"/>
        </div>
        <div style="grid-column:1/-1">
          <label>Servi√ßo</label>
          <select id="m_service" disabled></select>
          <div class="muted" style="margin-top:6px">O servi√ßo mostrado √© o que est√° dispon√≠vel para este hor√°rio.</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="m_send">Enviar pedido</button>
        <button class="btn ghost" id="m_cancel">Cancelar</button>
      </div>

      <div class="muted" id="m_status" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- WhatsApp -->
  <div class="whatsapp-float">
    <a
      class="whatsapp-btn"
      href="https://wa.me/5565999731422"
      target="_blank"
      aria-label="Contato via WhatsApp"
    >
      <!-- √çcone WhatsApp (SVG) -->
      <span class="wa-ico" aria-hidden="true">
        <svg viewBox="0 0 32 32" width="24" height="24" fill="none">
          <path fill="#fff" d="M16 3C9.373 3 4 8.152 4 14.53c0 2.52.86 4.85 2.33 6.73L5 29l7.97-1.99a12.55 12.55 0 0 0 3.03.36c6.627 0 12-5.152 12-11.53C28 8.152 22.627 3 16 3Zm0 21.1c-1.01 0-1.99-.15-2.9-.45l-.52-.17-4.73 1.18 1.27-4.48-.34-.5a9.45 9.45 0 0 1-1.61-5.25c0-5.2 4.39-9.43 9.83-9.43 5.44 0 9.83 4.23 9.83 9.43 0 5.2-4.39 9.43-9.83 9.43Z"/>
          <path fill="#fff" d="M21.58 18.64c-.26-.13-1.53-.74-1.77-.82-.24-.09-.41-.13-.59.13-.18.26-.68.82-.83.99-.15.17-.3.2-.56.07-.26-.13-1.1-.39-2.1-1.25-.78-.66-1.31-1.48-1.47-1.74-.15-.26-.02-.4.11-.53.12-.12.26-.3.39-.45.13-.15.18-.26.27-.43.09-.17.04-.33-.02-.46-.06-.13-.59-1.4-.81-1.92-.21-.5-.43-.44-.59-.44l-.5-.01c-.17 0-.44.06-.67.33-.23.26-.88.86-.88 2.1 0 1.24.9 2.44 1.02 2.61.13.17 1.77 2.75 4.3 3.75.6.25 1.07.4 1.43.51.6.19 1.15.16 1.58.1.48-.07 1.53-.62 1.75-1.22.22-.6.22-1.12.15-1.22-.06-.1-.24-.16-.5-.29Z"/>
        </svg>
      </span>
      <span>Qualquer d√∫vida entre em contato com n√≥s pelo WhatsApp 65 99973-1422</span>
    </a>
  </div>

  <script>
    // ======== CONFIGURE AQUI ========
    const SUPABASE_URL = "https://gmbonkieasgtfcevlsos.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_gML-mbcOr6nCQt-bNcQIWg_A9SHi38v";
    const OWNER_ID = "5261c0e7-ecbe-42a0-9f5d-5c0b00d18494";
    // ================================
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const list = document.getElementById("list");
    const money = (n)=> "R$ " + Number(n||0).toFixed(2);

    const backdrop = document.getElementById("backdrop");
    const mClose = document.getElementById("m_close");
    const mCancel = document.getElementById("m_cancel");
    const mSend = document.getElementById("m_send");
    const mInfo = document.getElementById("m_info");
    const mName = document.getElementById("m_name");
    const mPhone = document.getElementById("m_phone");
    const mService = document.getElementById("m_service");
    const mStatus = document.getElementById("m_status");

    let CURRENT = null; // slot selecionado

    function openModal(slot){
      CURRENT = slot;
      mStatus.textContent = "";
      mName.value = "";
      mPhone.value = "";
      const dt = new Date(slot.start_at).toLocaleString();
      const serviceName = slot.services?.name ?? "Servi√ßo";
      const price = slot.price_override ?? slot.services?.price ?? 0;

      mInfo.textContent = `${dt} ‚Ä¢ ${serviceName} ‚Ä¢ ${money(price)}`;
      mService.innerHTML = `<option>${serviceName}</option>`;
      backdrop.style.display = "flex";
    }
    function closeModal(){
      backdrop.style.display = "none";
      CURRENT = null;
    }
    mClose.onclick = closeModal;
    mCancel.onclick = closeModal;
    backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });

    async function load(){
      const { data, error } = await sb
        .from("availability")
        .select("id,start_at,price_override,service_id,services(id,name,price,material_cost)")
        .eq("owner_id", OWNER_ID)
        .eq("public", true)
        .eq("reserved", false)
        .order("start_at", { ascending: true });

      if(error){
        list.innerHTML = `<div class="card">Erro: ${error.message}</div>`;
        return;
      }
      if(!data || data.length===0){
        list.innerHTML = `<div class="card">Nenhum hor√°rio dispon√≠vel no momento.</div>`;
        return;
      }

      list.innerHTML = data.map(s=>{
        const dt = new Date(s.start_at).toLocaleString();
        const serviceName = s.services?.name ?? "Servi√ßo";
        const price = s.price_override ?? s.services?.price ?? 0;

        return `
          <div class="card" style="cursor:pointer" data-id="${s.id}">
            <div class="row">
              <div>
                <div style="font-weight:900">${dt}</div>
                <div class="badge">üìå ${serviceName}</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <div class="price">${money(price)}</div>
                <button class="btn" type="button">Agendar</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // click abre modal
      [...document.querySelectorAll('[data-id]')].forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-id");
          const slot = data.find(x=>x.id===id);
          if(slot) openModal(slot);
        });
      });
    }

    async function ensureClient(owner_id, name, phone){
      const { data: found, error: e1 } = await sb
        .from("clients")
        .select("id,name,phone")
        .eq("owner_id", owner_id)
        .eq("phone", phone)
        .maybeSingle();

      if(e1) throw new Error(e1.message);

      if(found?.id){
        if(name && (!found.name || found.name !== name)){
          const { error: eUp } = await sb.from("clients").update({ name }).eq("id", found.id);
          if(eUp) throw new Error(eUp.message);
        }
        return found.id;
      }

      const { data: ins, error: e2 } = await sb
        .from("clients")
        .insert({ owner_id, name, phone, instagram: null, notes: "Criado via agendamentos online" })
        .select("id")
        .single();

      if(e2) throw new Error(e2.message);
      return ins.id;
    }

    async function reserveAndCreateBooking(slot, client_id){
      const owner_id = OWNER_ID;
      const service_id = slot.service_id;
      const expected_price = Number(slot.price_override ?? slot.services?.price ?? 0);
      const expected_cost  = Number(slot.services?.material_cost ?? 0);

      const { data: upd, error: eUp } = await sb
        .from("availability")
        .update({ reserved: true })
        .eq("id", slot.id)
        .eq("reserved", false)
        .select("id")
        .maybeSingle();

      if(eUp) throw new Error(eUp.message);
      if(!upd?.id){
        throw new Error("Este hor√°rio acabou de ser reservado por outra pessoa. Atualize a p√°gina e escolha outro.");
      }

      const { error: eBk } = await sb
        .from("bookings")
        .insert({
          owner_id,
          client_id,
          service_id,
          start_at: slot.start_at,
          expected_price,
          expected_cost,
          status: "SCHEDULED"
        });

      if(eBk) throw new Error(eBk.message);
    }

    mSend.onclick = async ()=>{
      try{
        if(!CURRENT) return;

        const name = mName.value.trim();
        const phone = mPhone.value.trim();

        if(!name) { mStatus.textContent = "Informe seu nome."; return; }
        if(!phone) { mStatus.textContent = "Informe seu WhatsApp/telefone."; return; }

        mSend.disabled = true;
        mStatus.textContent = "Enviando pedido‚Ä¶";

        const client_id = await ensureClient(OWNER_ID, name, phone);
        await reserveAndCreateBooking(CURRENT, client_id);

        mStatus.textContent = "Pedido enviado com sucesso. Aguarde confirma√ß√£o.";

        setTimeout(async ()=>{
          closeModal();
          await load();
        }, 700);

      }catch(err){
        mStatus.textContent = "Erro: " + (err?.message || String(err));
      }finally{
        mSend.disabled = false;
      }
    };

    load();
  </script>
</body>
</html>

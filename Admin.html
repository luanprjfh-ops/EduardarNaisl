<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel Administrativo • Unhas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg0:#0B001D; --bg1:#120029; --bg2:#1E0040; --bg3:#3A0054;
      --neon:#BC0DD9; --neon2:#6F0FCF; --blue:#3D5BB6;
      --text:#F6F0FF; --muted:#CBB9FF;
      --glass: rgba(255,255,255,0.06); --glass2: rgba(255,255,255,0.04);
      --stroke: rgba(255,255,255,0.12);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px; --radius2: 22px;
      --focus: 0 0 0 4px rgba(61,91,182,0.18);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 12% 22%, rgba(188,13,217,0.22), transparent 60%),
        radial-gradient(1100px 700px at 76% 58%, rgba(61,91,182,0.18), transparent 60%),
        radial-gradient(900px 500px at 50% 10%, rgba(111,15,207,0.18), transparent 60%),
        linear-gradient(135deg, var(--bg0), var(--bg2), var(--bg3));
      overflow-x:hidden;
    }
    .hidden{display:none !important}

    .app{min-height:100%;display:grid;grid-template-columns:280px 1fr}
    @media (max-width:980px){.app{grid-template-columns:1fr}}

    body.unauth .app{grid-template-columns:1fr}
    body.unauth .side{display:none}
    body.unauth .main{max-width:980px;margin:0 auto}

    .side{
      position:sticky;top:0;height:100vh;padding:18px 14px;
      border-right:1px solid rgba(255,255,255,0.10);
      background:linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.10)), rgba(0,0,0,0.10);
      backdrop-filter: blur(14px);
    }
    @media (max-width:980px){
      .side{position:relative;height:auto;border-right:none;border-bottom:1px solid rgba(255,255,255,0.10)}
    }

    .brand{
      display:flex;align-items:center;gap:10px;padding:12px 12px;
      border:1px solid rgba(255,255,255,0.10);border-radius:var(--radius2);
      background:rgba(255,255,255,0.05);box-shadow:0 10px 40px rgba(0,0,0,0.35);
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(188,13,217,0.9), rgba(188,13,217,0.10) 55%),
        radial-gradient(circle at 70% 70%, rgba(61,91,182,0.7), rgba(61,91,182,0.08) 60%),
        linear-gradient(135deg, rgba(255,255,255,0.06), rgba(0,0,0,0.18));
      border:1px solid rgba(255,255,255,0.14);
      box-shadow:0 0 30px rgba(188,13,217,0.20);
    }
    .brand h1{margin:0;font-size:14px;font-weight:900;letter-spacing:.3px}
    .brand p{margin:2px 0 0;font-size:12px;color:rgba(255,255,255,0.72)}
    .who{margin:12px 4px 0;font-size:12px;color:rgba(255,255,255,0.72)}

    .nav{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .navbtn{
      display:flex;align-items:center;gap:10px;width:100%;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,0.12);
      background:rgba(0,0,0,0.18);color:var(--text);cursor:pointer;transition:.16s;text-align:left;
    }
    .navbtn:hover{transform:translateY(-1px);border-color:rgba(188,13,217,0.35);box-shadow:0 0 22px rgba(188,13,217,0.14)}
    .navbtn.active{
      background:linear-gradient(90deg, rgba(111,15,207,0.24), rgba(188,13,217,0.12));
      border-color:rgba(188,13,217,0.45);box-shadow:0 0 28px rgba(188,13,217,0.18);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,0.25);box-shadow:0 0 0 4px rgba(255,255,255,0.04)}
    .navbtn.active .dot{background:var(--neon);box-shadow:0 0 0 4px rgba(188,13,217,0.16), 0 0 18px rgba(188,13,217,0.35)}
    .navlabel{font-weight:900;font-size:13px}
    .navsub{font-size:11px;color:rgba(255,255,255,0.65);margin-top:2px}

    .main{padding:18px 18px 40px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .title{display:flex;flex-direction:column;gap:3px}
    .title .h{font-size:18px;font-weight:950;letter-spacing:.2px}
    .title .s{font-size:12px;color:rgba(255,255,255,0.72)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .btn{
      border:1px solid rgba(188,13,217,0.45);
      background:linear-gradient(90deg, rgba(111,15,207,0.26), rgba(188,13,217,0.18));
      color:var(--text);padding:10px 14px;border-radius:14px;cursor:pointer;transition:.18s;
      box-shadow:0 0 22px rgba(188,13,217,0.16);font-weight:900;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 0 30px rgba(188,13,217,0.28)}
    .btn.ghost{border-color:rgba(255,255,255,0.16);background:rgba(255,255,255,0.06);box-shadow:none}
    .btn.danger{border-color:rgba(255,120,120,0.55);background:rgba(255,50,50,0.12);box-shadow:none}

    .card{background:var(--glass);border:1px solid var(--stroke);border-radius:var(--radius2);backdrop-filter:blur(14px);box-shadow:var(--shadow)}
    .cardhead{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.10);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .cardhead .h2{font-size:14px;font-weight:950;margin:0}
    .cardhead .p2{margin:4px 0 0;font-size:12px;color:rgba(255,255,255,0.70)}
    .cardbody{padding:14px 16px}
    .grid{display:grid;grid-template-columns:repeat(12, 1fr);gap:10px}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    @media (max-width:980px){.col-3,.col-4{grid-column:span 6}.col-6,.col-8{grid-column:span 12}}

    label{display:block;font-size:11px;color:rgba(255,255,255,0.70);margin:0 0 6px 2px}
    input,select,textarea{width:100%;padding:11px 12px;border-radius:14px;border:1px solid rgba(255,255,255,0.16);background:rgba(0,0,0,0.25);color:var(--text);outline:none}
    textarea{min-height:92px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:rgba(61,91,182,0.62);box-shadow:var(--focus)}
    .help{margin-top:6px;font-size:11px;color:rgba(255,255,255,0.60)}

    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .item{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;padding:12px 12px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.10);background:var(--glass2)}
    .item .t{font-weight:950}.item .m{font-size:12px;color:rgba(255,255,255,0.72);margin-top:4px}
    .item .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{padding:6px 10px;border-radius:999px;border:1px solid rgba(61,91,182,0.45);background:rgba(61,91,182,0.12);font-size:11px;color:rgba(255,255,255,0.88);white-space:nowrap}
    .badge.neon{border-color:rgba(188,13,217,0.45);background:rgba(188,13,217,0.12)}
    .muted{color:rgba(255,255,255,0.70)}

    .stats{display:grid;grid-template-columns:repeat(12, 1fr);gap:10px}
    .stat{grid-column:span 3;padding:14px 14px}.stat.big{grid-column:span 6}
    @media (max-width:980px){.stat{grid-column:span 6}.stat.big{grid-column:span 12}}
    .k{font-size:11px;color:rgba(255,255,255,0.70)}
    .v{font-size:22px;font-weight:950;margin-top:6px}.v.small{font-size:18px}

    .toastwrap{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:9999;pointer-events:none}
    .toast{pointer-events:auto;min-width:260px;max-width:360px;padding:12px 12px;border-radius:16px;border:1px solid rgba(255,255,255,0.14);background:rgba(0,0,0,0.35);backdrop-filter:blur(16px);box-shadow:0 16px 60px rgba(0,0,0,0.55);display:flex;gap:10px;align-items:flex-start;animation:pop .16s ease-out}
    @keyframes pop{from{transform:translateY(6px);opacity:.2}to{transform:translateY(0);opacity:1}}
    .toast .ico{width:22px;height:22px;border-radius:8px;margin-top:2px}
    .toast.ok .ico{background:rgba(189,247,199,0.18);border:1px solid rgba(189,247,199,0.40)}
    .toast.err .ico{background:rgba(255,179,179,0.14);border:1px solid rgba(255,179,179,0.40)}
    .toast.warn .ico{background:rgba(255,233,166,0.14);border:1px solid rgba(255,233,166,0.40)}
    .toast .tt{font-weight:950;font-size:13px}
    .toast .tx{font-size:12px;color:rgba(255,255,255,0.78);margin-top:2px;line-height:1.25}
    .toast .x{margin-left:auto;background:transparent;border:1px solid rgba(255,255,255,0.16);color:rgba(255,255,255,0.85);border-radius:10px;padding:6px 8px;cursor:pointer}
  </style>
</head>

<body class="unauth">
<div class="app">
  <aside class="side">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Painel Administrativo • Unhas</h1>
        <p>Agenda • Serviços • Fidelidade</p>
      </div>
    </div>
    <div class="who" id="who">Carregando sessão…</div>

    <div class="nav" id="nav"></div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn ghost" id="refreshBtn">Atualizar</button>
      <button class="btn danger" id="logoutBtn">Sair</button>
    </div>

    <div class="who" style="margin-top:10px; opacity:.9">
      <div class="muted" style="font-size:11px; line-height:1.3">
        Ordem: <b>Serviços</b> → <b>Dias disponíveis</b> → <b>Agendamentos online</b> → <b>Finalizar</b>.
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar hidden" id="topbar">
      <div class="title">
        <div class="h" id="pageTitle">Dashboard</div>
        <div class="s" id="pageSub">Resumo de atendimentos e lucro</div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnOpenPublic">Abrir público</button>
        <button class="btn" id="btnOpenAdmin">Link Admin</button>
      </div>
    </div>

    <!-- LOGIN -->
    <section class="card" id="loginSection">
      <div class="cardhead">
        <div>
          <h2 class="h2">Entrar</h2>
          <div class="p2">Faça login com o usuário do Supabase (Authentication → Users)</div>
        </div>
      </div>
      <div class="cardbody">
        <div class="grid">
          <div class="col-4">
            <label>Email</label>
            <input id="email" placeholder="ex: sua@conta.com" autocomplete="username"/>
          </div>
          <div class="col-4">
            <label>Senha</label>
            <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password"/>
          </div>
          <div class="col-4" style="display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap">
            <button class="btn" id="loginBtn">Entrar</button>
            <button class="btn ghost" id="magicBtn" title="Envia link para entrar sem senha">Magic Link</button>
          </div>
          <div class="col-12">
            <div class="help">Dica: se abrir o link dentro do app do Gmail e não logar, clique em “Abrir no navegador”.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- DASH -->
    <section class="card hidden" id="dashSection">
      <div class="cardhead">
        <div>
          <h2 class="h2">Dashboard</h2>
          <div class="p2">Lucro real (finalizados) + lucro esperado (agenda futura)</div>
        </div>
      </div>
      <div class="cardbody">
        <div class="stats">
          <div class="card stat"><div class="k">Hoje • Unhas</div><div class="v" id="d_count">-</div></div>
          <div class="card stat"><div class="k">Hoje • Lucro</div><div class="v" id="d_profit">-</div></div>
          <div class="card stat"><div class="k">Mês • Unhas</div><div class="v" id="m_count">-</div></div>
          <div class="card stat"><div class="k">Mês • Lucro</div><div class="v" id="m_profit">-</div></div>
          <div class="card stat"><div class="k">Ano • Unhas</div><div class="v" id="y_count">-</div></div>
          <div class="card stat"><div class="k">Ano • Lucro</div><div class="v" id="y_profit">-</div></div>
          <div class="card stat big">
            <div class="k">Futuro • Lucro esperado (agendados)</div>
            <div class="v" id="expected_profit">-</div>
            <div class="help">Soma (expected_price - expected_cost) onde status = SCHEDULED</div>
          </div>
          <div class="card stat big">
            <div class="k">Atalhos</div>
            <div class="v small">Serviços → Dias disponíveis → Agendamentos online → Finalizar ✅</div>
            <div class="help">O público só enxerga horários com <b>public=true</b> e <b>reserved=false</b>.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section class="card hidden" id="clientsSection">
      <div class="cardhead">
        <div>
          <h2 class="h2">Clientes</h2>
          <div class="p2">Cadastrar, buscar e excluir</div>
        </div>
        <div class="badge neon">Fidelidade cria automaticamente</div>
      </div>
      <div class="cardbody">
        <div class="grid">
          <div class="col-4"><label>Nome</label><input id="c_name" placeholder="Nome do cliente"/></div>
          <div class="col-4"><label>WhatsApp</label><input id="c_phone" placeholder="(DDD) 99999-9999"/></div>
          <div class="col-4"><label>Instagram (opcional)</label><input id="c_insta" placeholder="@usuario"/></div>
          <div class="col-8"><label>Buscar</label><input id="c_search" placeholder="Digite nome ou telefone..."/></div>
          <div class="col-4" style="display:flex; align-items:flex-end"><button class="btn" id="c_add" style="width:100%">Salvar cliente</button></div>
        </div>
        <div class="list" id="c_list"></div>
      </div>
    </section>

    <!-- SERVIÇOS -->
    <section class="card hidden" id="servicesSection">
      <div class="cardhead">
        <div>
          <h2 class="h2">Serviços</h2>
          <div class="p2">Preço, custo e lucro por serviço</div>
        </div>
        <div class="badge">Lucro = preço - custo</div>
      </div>
      <div class="cardbody">
        <div class="grid">
          <div class="col-6"><label>Nome do serviço</label><input id="s_name" placeholder="Ex: Alongamento, Manicure, Unha..."/></div>
          <div class="col-3"><label>Preço</label><input id="s_price" inputmode="decimal" placeholder="Ex: 120"/></div>
          <div class="col-3"><label>Custo (material)</label><input id="s_cost" inputmode="decimal" placeholder="Ex: 30"/></div>
          <div class="col-12">
            <button class="btn" id="s_add">Salvar serviço</button>
            <div class="help">Dica: coloque o custo médio pra calcular o lucro no atendimento.</div>
          </div>
        </div>
        <div class="list" id="s_list"></div>
      </div>
    </section>

    <!-- DIAS DISPONÍVEIS -->
    <section class="card hidden" id="availSection">
      <div class="cardhead">
        <div>
          <h2 class="h2">Dias disponíveis</h2>
          <div class="p2">Horários publicados para o público</div>
        </div>
        <div class="badge neon">Aparece no site público</div>
      </div>
      <div class="cardbody">
        <div class="grid">
          <div class="col-3"><label>Data</label><input id="a_date" type="date"/></div>
          <div class="col-3"><label>Hora</label><input id="a_time" type="time"/></div>
          <div class="col-4"><label>Serviço</label><select id="a_service"></select></div>
          <div class="col-2"><label>Preço override</label><input id="a_override" inputmode="decimal" placeholder="Opcional"/></div>
          <div class="col-12">
            <button class="btn" id="a_add">Adicionar horário</button>
            <div class="help">Use “Ocultar/Publicar” pra controlar o que aparece no público.</div>
          </div>
        </div>
        <div class="list" id="a_list"></div>
      </div>
    </section>

    <!-- AGENDAMENTOS ONLINE -->
    <section class="card hidden" id="onlineSection">
      <div class="cardhead">
        <div>
          <h2 class="h2">Agendamentos online</h2>
          <div class="p2">Pedidos recebidos do site público (nome, contato, serviço e horário)</div>
        </div>
        <div class="badge neon">Use “Finalizar pedido” para ir direto na tela de finalização</div>
      </div>
      <div class="cardbody">
        <div class="help">
          Aqui aparecem automaticamente os agendamentos criados pelo público. Ao finalizar, o status vira <b>DONE</b>.
        </div>
        <div class="list" id="o_list"></div>
      </div>
    </section>

    <!-- AGENDA FUTURA (manual) -->
    <section class="card hidden" id="bookSection">
      <div class="cardhead">
        <div>
          <h2 class="h2">Agenda futura</h2>
          <div class="p2">Registrar atendimentos futuros e lucro esperado</div>
        </div>
        <div class="badge">SCHEDULED / DONE / CANCELLED</div>
      </div>
      <div class="cardbody">
        <div class="grid">
          <div class="col-4"><label>Cliente</label><select id="b_client"></select></div>
          <div class="col-4"><label>Serviço</label><select id="b_service"></select></div>
          <div class="col-2"><label>Data</label><input id="b_date" type="date"/></div>
          <div class="col-2"><label>Hora</label><input id="b_time" type="time"/></div>
          <div class="col-3"><label>Preço previsto</label><input id="b_price" inputmode="decimal" placeholder="Auto pelo serviço"/></div>
          <div class="col-3"><label>Custo previsto</label><input id="b_cost" inputmode="decimal" placeholder="Auto pelo serviço"/></div>
          <div class="col-6" style="display:flex; align-items:flex-end"><button class="btn" id="b_add" style="width:100%">Salvar agendamento</button></div>
        </div>
        <div class="list" id="b_list"></div>
      </div>
    </section>

    <!-- FINALIZAR -->
    <section class="card hidden" id="finalSection">
      <div class="cardhead">
        <div>
          <h2 class="h2">Finalizar unha</h2>
          <div class="p2">Registrar atendimento feito (lucro real + fidelidade)</div>
        </div>
        <div class="badge neon">Atendimento finalizado</div>
      </div>
      <div class="cardbody">
        <div class="grid">
          <div class="col-8"><label>Agendamento (opcional)</label><select id="f_booking"></select></div>
          <div class="col-4" style="display:flex; gap:10px; align-items:flex-end">
            <button class="btn ghost" id="f_useBooking" style="flex:1">Carregar</button>
            <select id="f_pay" style="flex:1">
              <option>Pix</option><option>Dinheiro</option><option>Crédito</option><option>Débito</option><option>Outros</option>
            </select>
          </div>
          <div class="col-4"><label>Cliente</label><select id="f_client"></select></div>
          <div class="col-4"><label>Serviço</label><select id="f_service"></select></div>
          <div class="col-2"><label>Valor cobrado</label><input id="f_price" inputmode="decimal" placeholder="Ex: 120"/></div>
          <div class="col-2"><label>Custo material</label><input id="f_cost" inputmode="decimal" placeholder="Ex: 30"/></div>
          <div class="col-8"><label>Observações</label><textarea id="f_notes" placeholder="Opcional"></textarea></div>
          <div class="col-2"><label>Pontos fidelidade (+)</label><input id="f_points" placeholder="Ex: 1" value="1"/></div>
          <div class="col-2" style="display:flex; align-items:flex-end"><button class="btn" id="f_done" style="width:100%">Finalizar</button></div>
        </div>
      </div>
    </section>

    <!-- FIDELIDADE -->
    <section class="card hidden" id="loySection">
      <div class="cardhead">
        <div>
          <h2 class="h2">Fidelidade</h2>
          <div class="p2">Pontos por cliente</div>
        </div>
        <div class="badge">Acumula ao finalizar</div>
      </div>
      <div class="cardbody">
        <div class="grid">
          <div class="col-12"><label>Buscar cliente</label><input id="l_search" placeholder="Digite o nome..."/></div>
        </div>
        <div class="list" id="l_list"></div>
      </div>
    </section>

  </main>
</div>

<div class="toastwrap" id="toasts"></div>

<script>
  // ===== CONFIG (suas infos) =====
  const SUPABASE_URL = "https://gmbonkieasgtfcevlsos.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_gML-mbcOr6nCQt-bNcQIWg_A9SHi38v";

  // IMPORTANTE: forçar persistência e detectar sessão na URL
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  });

  // Ajuste aqui para o seu GitHub Pages
  const PUBLIC_URL = "https://luanprjfh-ops.github.io/EduardarNaisl/";
  const ADMIN_FILE = "Admin.html";
  // ===============================

  const $ = (id)=>document.getElementById(id);
  const money = (n)=> "R$ " + Number(n||0).toFixed(2);
  const num = (v)=> Number(String(v||"0").replace(",", ".") || 0);

  const PAGES = [
    { id:"dashSection",    title:"Dashboard",           sub:"Resumo de atendimentos e lucro" },
    { id:"clientsSection", title:"Clientes",            sub:"Cadastrar e buscar clientes" },
    { id:"servicesSection",title:"Serviços",            sub:"Preço, custo e lucro por serviço" },
    { id:"availSection",   title:"Dias disponíveis",    sub:"Publicar horários no site público" },
    { id:"onlineSection",  title:"Agendamentos online", sub:"Pedidos recebidos do site público" },
    { id:"bookSection",    title:"Agenda futura",       sub:"Registrar futuras unhas e lucro esperado" },
    { id:"finalSection",   title:"Finalizar unha",      sub:"Registrar atendimento feito e fidelidade" },
    { id:"loySection",     title:"Fidelidade",          sub:"Ver pontos por cliente" },
  ];

  function toast(type, title, text){
    const wrap = $("toasts");
    const el = document.createElement("div");
    el.className = "toast " + (type || "ok");
    el.innerHTML = `
      <div class="ico"></div>
      <div>
        <div class="tt">${title || ""}</div>
        <div class="tx">${text || ""}</div>
      </div>
      <button class="x">✕</button>
    `;
    el.querySelector(".x").onclick = ()=> el.remove();
    wrap.appendChild(el);
    setTimeout(()=>{ if(el.isConnected) el.remove(); }, 4500);
  }

  function hideAllPages(){
    for(const p of PAGES) $(p.id).classList.add("hidden");
  }

  function setPage(id){
    if(!CACHE.user) return;
    for(const p of PAGES){
      $(p.id).classList.toggle("hidden", p.id !== id);
    }
    document.querySelectorAll(".navbtn").forEach(b=>{
      b.classList.toggle("active", b.dataset.target === id);
    });
    const page = PAGES.find(x=>x.id===id) || PAGES[0];
    $("pageTitle").textContent = page.title;
    $("pageSub").textContent = page.sub;
  }

  function buildNav(){
    const nav = $("nav");
    nav.innerHTML = PAGES.map(p=>`
      <button class="navbtn" data-target="${p.id}">
        <span class="dot"></span>
        <span>
          <div class="navlabel">${p.title}</div>
          <div class="navsub">${p.sub}</div>
        </span>
      </button>
    `).join("");
    nav.querySelectorAll(".navbtn").forEach(b=>{
      b.onclick = async ()=>{
        setPage(b.dataset.target);
        await refreshAll();
      };
    });
  }

  // Links úteis
  $("btnOpenPublic").onclick = ()=> window.open(PUBLIC_URL, "_blank");
  $("btnOpenAdmin").onclick  = ()=> window.open(PUBLIC_URL + ADMIN_FILE, "_blank");

  let CACHE = { user:null, clients:[], services:[], bookings:[] };

  // ====== FIX DO MAGIC LINK / REDIRECT ======
  async function handleAuthRedirect(){
    const url = new URL(window.location.href);
    const qs = url.searchParams;

    const token_hash = qs.get("token_hash");
    const type = qs.get("type"); // magiclink / recovery / invite
    const code = qs.get("code");

    // Caso 1: Magic Link (token_hash + type)
    if(token_hash && type){
      const { error } = await sb.auth.verifyOtp({ type, token_hash });
      if(error){
        toast("err","Magic Link", error.message);
      }else{
        toast("ok","Magic Link","Sessão aplicada com sucesso.");
      }
      qs.delete("token_hash");
      qs.delete("type");
      qs.delete("redirect_to");
      window.history.replaceState({}, document.title, url.pathname + (qs.toString() ? ("?" + qs.toString()) : ""));
    }

    // Caso 2: PKCE (code)
    if(code){
      const { error } = await sb.auth.exchangeCodeForSession(code);
      if(error){
        toast("err","Login (code)", error.message);
      }else{
        toast("ok","Login","Sessão aplicada com sucesso.");
      }
      qs.delete("code");
      qs.delete("next");
      window.history.replaceState({}, document.title, url.pathname + (qs.toString() ? ("?" + qs.toString()) : ""));
    }

    // Se tiver erro na URL (alguns casos)
    const errDesc = qs.get("error_description");
    if(errDesc){
      toast("err","Auth", decodeURIComponent(errDesc));
    }
  }
  // ==========================================

  async function loadUser(){
    const { data: { user } } = await sb.auth.getUser();
    CACHE.user = user;
    return user;
  }

  function applyAuthUI(user){
    document.body.classList.toggle("unauth", !user);

    $("loginSection").classList.toggle("hidden", !!user);
    $("topbar").classList.toggle("hidden", !user);

    if(!user){
      $("who").textContent = "Deslogado";
      hideAllPages();
      document.querySelectorAll(".navbtn").forEach(b=>b.classList.remove("active"));
      return;
    }
    $("who").textContent = `Logado: ${user.email}`;
  }

  $("loginBtn").onclick = async ()=>{
    const email = $("email").value.trim();
    const password = $("pass").value;
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error) return toast("err","Login falhou", error.message);
    toast("ok","Bem-vindo","Login realizado.");
    await refreshAll();
  };

  $("magicBtn").onclick = async ()=>{
    const email = $("email").value.trim();
    if(!email) return toast("warn","Informe o email","Digite o email e tente novamente.");

    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: PUBLIC_URL + ADMIN_FILE }
    });

    if(error) return toast("err","Falha ao enviar link", error.message);
    toast("ok","Link enviado","Abra o link no mesmo dispositivo/navegador onde quer ficar logado.");
  };

  $("logoutBtn").onclick = async ()=>{
    await sb.auth.signOut();
    toast("ok","Saiu","Você foi deslogado.");
    await refreshAll();
  };

  $("refreshBtn").onclick = async ()=> refreshAll();
  sb.auth.onAuthStateChange(()=>refreshAll());

  async function loadClients(){
    const user = CACHE.user;
    if(!user) return [];
    const { data, error } = await sb.from("clients")
      .select("id,name,phone,instagram,created_at")
      .eq("owner_id", user.id)
      .order("created_at", { ascending:false });
    if(error){ toast("err","Clientes", error.message); return []; }
    CACHE.clients = data || [];
    return CACHE.clients;
  }

  async function loadServices(){
    const user = CACHE.user;
    if(!user) return [];
    const { data, error } = await sb.from("services")
      .select("id,name,price,material_cost,active,created_at")
      .eq("owner_id", user.id)
      .order("created_at", { ascending:false });
    if(error){ toast("err","Serviços", error.message); return []; }
    CACHE.services = data || [];
    return CACHE.services;
  }

  async function loadBookings(){
    const user = CACHE.user;
    if(!user) return [];
    const { data, error } = await sb.from("bookings")
      .select("id,start_at,status,expected_price,expected_cost,client_id,service_id")
      .eq("owner_id", user.id)
      .order("start_at", { ascending:true });
    if(error){ toast("err","Agendamentos", error.message); return []; }
    CACHE.bookings = data || [];
    return CACHE.bookings;
  }

  function fillClientSelect(selectId, allowEmpty=true){
    const sel = $(selectId);
    const opts = [];
    if(allowEmpty) opts.push(`<option value="">Selecione cliente</option>`);
    for(const c of CACHE.clients){
      opts.push(`<option value="${c.id}">${c.name}${c.phone ? " • "+c.phone : ""}</option>`);
    }
    sel.innerHTML = opts.join("");
  }

  function fillServiceSelect(selectId, allowEmpty=true){
    const sel = $(selectId);
    const opts = [];
    if(allowEmpty) opts.push(`<option value="">Selecione serviço</option>`);
    for(const s of CACHE.services.filter(x=>x.active)){
      opts.push(`<option value="${s.id}">${s.name} (R$ ${Number(s.price||0).toFixed(2)})</option>`);
    }
    sel.innerHTML = opts.join("");
  }

  function serviceById(id){ return CACHE.services.find(s=>s.id===id); }
  function clientById(id){ return CACHE.clients.find(c=>c.id===id); }

  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function startOfMonth(d){ return startOfDay(new Date(d.getFullYear(), d.getMonth(), 1)); }
  function startOfYear(d){ return startOfDay(new Date(d.getFullYear(), 0, 1)); }

  async function renderDashboard(){
    const user = CACHE.user;
    if(!user) return;

    const { data: appts, error } = await sb.from("appointments").select("done_at, profit").eq("owner_id", user.id);
    if(error) return toast("err","Dashboard", error.message);

    const now = new Date();
    const bucket = (fromDate)=>{
      const rows = (appts||[]).filter(r => new Date(r.done_at) >= fromDate);
      return { count: rows.length, profit: rows.reduce((a,r)=>a + Number(r.profit||0), 0) };
    };

    const d = bucket(startOfDay(now)), m = bucket(startOfMonth(now)), y = bucket(startOfYear(now));
    $("d_count").textContent = d.count;
    $("d_profit").textContent = money(d.profit);
    $("m_count").textContent = m.count;
    $("m_profit").textContent = money(m.profit);
    $("y_count").textContent = y.count;
    $("y_profit").textContent = money(y.profit);

    const { data: bks, error: e2 } = await sb.from("bookings")
      .select("expected_price, expected_cost").eq("owner_id", user.id).eq("status", "SCHEDULED");
    if(e2) return toast("err","Lucro esperado", e2.message);

    const exp = (bks||[]).reduce((a,r)=>a + (Number(r.expected_price||0) - Number(r.expected_cost||0)), 0);
    $("expected_profit").textContent = money(exp);
  }

  function renderClients(){
    const q = ($("c_search").value || "").toLowerCase();
    const rows = CACHE.clients.filter(c => (c.name||"").toLowerCase().includes(q) || (c.phone||"").toLowerCase().includes(q));
    $("c_list").innerHTML = rows.map(c=>`
      <div class="item">
        <div><div class="t">${c.name}</div><div class="m">${c.phone || "-"} • ${c.instagram || "-"}</div></div>
        <div class="right"><button class="btn danger" onclick="delClient('${c.id}')">Excluir</button></div>
      </div>
    `).join("") || `<div class="muted">Nenhum cliente.</div>`;
  }

  async function addClient(){
    const user = CACHE.user;
    const name = $("c_name").value.trim();
    const phone = $("c_phone").value.trim() || null;
    const instagram = $("c_insta").value.trim() || null;
    if(!name) return toast("warn","Clientes","Informe o nome.");

    const { error } = await sb.from("clients").insert({ owner_id: user.id, name, phone, instagram, notes: null });
    if(error) return toast("err","Clientes", error.message);

    $("c_name").value=""; $("c_phone").value=""; $("c_insta").value="";
    await loadClients();
    fillClientSelect("b_client"); fillClientSelect("f_client");
    renderClients();
    toast("ok","Clientes","Cliente salvo!");
  }

  async function delClient(id){
    if(!confirm("Excluir cliente?")) return;
    const { error } = await sb.from("clients").delete().eq("id", id);
    if(error) return toast("err","Clientes", error.message);
    await loadClients();
    renderClients();
    fillClientSelect("b_client"); fillClientSelect("f_client");
    toast("ok","Clientes","Cliente excluído.");
  }
  window.delClient = delClient;

  $("c_add").onclick = addClient;
  $("c_search").oninput = renderClients;

  function renderServices(){
    $("s_list").innerHTML = CACHE.services.map(s=>{
      const lucro = Number(s.price||0) - Number(s.material_cost||0);
      return `
        <div class="item">
          <div>
            <div class="t">${s.name} ${s.active ? "" : "<span class='muted'>(inativo)</span>"}</div>
            <div class="m">Preço: ${money(s.price)} • Custo: ${money(s.material_cost)} • Lucro: ${money(lucro)}</div>
          </div>
          <div class="right">
            <button class="btn ghost" onclick="toggleService('${s.id}', ${s.active})">${s.active ? "Desativar" : "Ativar"}</button>
            <button class="btn danger" onclick="delService('${s.id}')">Excluir</button>
          </div>
        </div>`;
    }).join("") || `<div class="muted">Nenhum serviço.</div>`;
  }

  async function addService(){
    const user = CACHE.user;
    const name = $("s_name").value.trim();
    const price = num($("s_price").value);
    const cost  = num($("s_cost").value);
    if(!name) return toast("warn","Serviços","Informe o nome do serviço.");

    const { error } = await sb.from("services").insert({ owner_id: user.id, name, price, material_cost: cost, active:true });
    if(error) return toast("err","Serviços", error.message);

    $("s_name").value=""; $("s_price").value=""; $("s_cost").value="";
    await loadServices();
    fillServiceSelect("a_service"); fillServiceSelect("b_service"); fillServiceSelect("f_service");
    renderServices();
    toast("ok","Serviços","Serviço salvo!");
  }

  async function toggleService(id, active){
    const { error } = await sb.from("services").update({ active: !active }).eq("id", id);
    if(error) return toast("err","Serviços", error.message);
    await loadServices();
    fillServiceSelect("a_service"); fillServiceSelect("b_service"); fillServiceSelect("f_service");
    renderServices();
  }

  async function delService(id){
    if(!confirm("Excluir serviço?")) return;
    const { error } = await sb.from("services").delete().eq("id", id);
    if(error) return toast("err","Serviços", error.message);
    await loadServices();
    fillServiceSelect("a_service"); fillServiceSelect("b_service"); fillServiceSelect("f_service");
    renderServices();
    toast("ok","Serviços","Serviço excluído.");
  }
  window.toggleService = toggleService;
  window.delService = delService;
  $("s_add").onclick = addService;

  async function renderAvailability(){
    const user = CACHE.user;
    const { data, error } = await sb.from("availability")
      .select("id,start_at,public,reserved,price_override,service_id, services(name,price)")
      .eq("owner_id", user.id).order("start_at", { ascending:true });
    if(error) return toast("err","Dias disponíveis", error.message);

    $("a_list").innerHTML = (data||[]).map(r=>{
      const dt = new Date(r.start_at).toLocaleString();
      const sname = r.services?.name || "Serviço";
      const price = r.price_override ?? r.services?.price ?? 0;
      return `
        <div class="item">
          <div>
            <div class="t">${dt} • ${sname}</div>
            <div class="m">Preço: ${money(price)} • Público: ${r.public ? "SIM" : "NÃO"} • Reservado: ${r.reserved ? "SIM" : "NÃO"}</div>
          </div>
          <div class="right">
            <button class="btn ghost" onclick="toggleAvail('${r.id}', ${r.public})">${r.public ? "Ocultar" : "Publicar"}</button>
            <button class="btn danger" onclick="delAvail('${r.id}')">Excluir</button>
          </div>
        </div>`;
    }).join("") || `<div class="muted">Nenhum horário cadastrado.</div>`;
  }

  async function addAvail(){
    const user = CACHE.user;
    const date = $("a_date").value, time = $("a_time").value;
    const service_id = $("a_service").value || null;
    const price_override = $("a_override").value.trim() ? num($("a_override").value) : null;

    if(!date || !time) return toast("warn","Dias disponíveis","Selecione data e hora.");
    if(!service_id) return toast("warn","Dias disponíveis","Selecione o serviço.");

    const start_at = new Date(`${date}T${time}:00`).toISOString();
    const { error } = await sb.from("availability").insert({ owner_id:user.id, start_at, service_id, price_override, public:true, reserved:false });
    if(error) return toast("err","Dias disponíveis", error.message);

    $("a_override").value="";
    toast("ok","Dias disponíveis","Horário adicionado!");
    await renderAvailability();
  }

  async function toggleAvail(id, curPublic){
    const { error } = await sb.from("availability").update({ public: !curPublic }).eq("id", id);
    if(error) return toast("err","Dias disponíveis", error.message);
    await renderAvailability();
  }
  async function delAvail(id){
    if(!confirm("Excluir horário?")) return;
    const { error } = await sb.from("availability").delete().eq("id", id);
    if(error) return toast("err","Dias disponíveis", error.message);
    await renderAvailability();
  }
  window.toggleAvail = toggleAvail; window.delAvail = delAvail;
  $("a_add").onclick = addAvail;

  // ======= AGENDA FUTURA (LISTA) =======
  function renderBookingsList(rows){
    $("b_list").innerHTML = rows.map(b=>{
      const c = clientById(b.client_id), s = serviceById(b.service_id);
      const dt = new Date(b.start_at).toLocaleString();
      const exp = Number(b.expected_price||0) - Number(b.expected_cost||0);
      const phone = c?.phone ? ` • ${c.phone}` : "";
      return `
        <div class="item">
          <div>
            <div class="t">${dt} • ${(c?.name||"Cliente")}${phone} • ${(s?.name||"Serviço")}</div>
            <div class="m">
              Status: <span class="badge ${b.status==="SCHEDULED" ? "neon" : ""}">${b.status}</span>
              • Previsto: ${money(b.expected_price)} • Custo: ${money(b.expected_cost)} • Lucro: ${money(exp)}
            </div>
          </div>
          <div class="right">
            ${b.status==="SCHEDULED" ? `<button class="btn danger" onclick="cancelBooking('${b.id}')">Cancelar</button>` : `<span class="muted">—</span>`}
          </div>
        </div>`;
    }).join("") || `<div class="muted">Nenhum agendamento.</div>`;
  }

  // ======= AGENDAMENTOS ONLINE =======
  function renderOnlineBookings(){
    const rows = CACHE.bookings
      .filter(b => b.status === "SCHEDULED")
      .slice(0, 300);

    $("o_list").innerHTML = rows.map(b=>{
      const c = clientById(b.client_id), s = serviceById(b.service_id);
      const dt = new Date(b.start_at).toLocaleString();
      const phone = c?.phone ? c.phone : "-";
      return `
        <div class="item">
          <div>
            <div class="t">${dt} • ${(c?.name||"Cliente")} • ${(s?.name||"Serviço")}</div>
            <div class="m">
              Contato: <b>${phone}</b>
              • Status: <span class="badge neon">${b.status}</span>
              • Previsto: ${money(b.expected_price)} (custo ${money(b.expected_cost)})
            </div>
          </div>
          <div class="right">
            <button class="btn" onclick="goFinalize('${b.id}')">Finalizar pedido</button>
            <button class="btn danger" onclick="cancelBooking('${b.id}')">Cancelar</button>
          </div>
        </div>
      `;
    }).join("") || `<div class="muted">Nenhum agendamento online no momento.</div>`;
  }

  async function goFinalize(bookingId){
    try{
      setPage("finalSection");
      // NÃO chama refreshAll completo aqui (evita flicker); só garante dropdown atualizado:
      await loadBookings();
      await refreshFinalizeBookingSelect();

      $("f_booking").value = bookingId;
      $("f_useBooking").click();
      toast("ok","Finalizar pedido","Agendamento carregado. Complete e clique em Finalizar.");
    }catch(e){
      toast("err","Finalizar pedido", e?.message || String(e));
    }
  }
  window.goFinalize = goFinalize;

  async function addBooking(){
    const user = CACHE.user;
    const client_id = $("b_client").value, service_id = $("b_service").value;
    const date = $("b_date").value, time = $("b_time").value;
    const expected_price = num($("b_price").value), expected_cost = num($("b_cost").value);

    if(!client_id) return toast("warn","Agenda futura","Selecione o cliente.");
    if(!service_id) return toast("warn","Agenda futura","Selecione o serviço.");
    if(!date || !time) return toast("warn","Agenda futura","Selecione data e hora.");

    const start_at = new Date(`${date}T${time}:00`).toISOString();
    const { error } = await sb.from("bookings").insert({ owner_id:user.id, client_id, service_id, start_at, expected_price, expected_cost, status:"SCHEDULED" });
    if(error) return toast("err","Agenda futura", error.message);

    toast("ok","Agenda futura","Agendamento salvo!");
    await loadBookings();
    renderBookingsList(CACHE.bookings);
    renderOnlineBookings();
    await refreshFinalizeBookingSelect();
    await renderDashboard();
  }

  async function cancelBooking(id){
    if(!confirm("Cancelar agendamento?")) return;
    const { error } = await sb.from("bookings").update({ status:"CANCELLED" }).eq("id", id);
    if(error) return toast("err","Agendamentos", error.message);

    await loadBookings();
    renderBookingsList(CACHE.bookings);
    renderOnlineBookings();
    await refreshFinalizeBookingSelect();
    await renderDashboard();
  }
  window.cancelBooking = cancelBooking;

  $("b_service").onchange = ()=>{
    const s = serviceById($("b_service").value);
    if(!s) return;
    $("b_price").value = String(Number(s.price||0).toFixed(2));
    $("b_cost").value  = String(Number(s.material_cost||0).toFixed(2));
  };
  $("b_add").onclick = addBooking;

  async function refreshFinalizeBookingSelect(){
    const scheduled = CACHE.bookings.filter(b=>b.status==="SCHEDULED").slice(0,300);
    $("f_booking").innerHTML = [`<option value="">(Opcional) Escolha um agendamento</option>`].concat(
      scheduled.map(b=>{
        const c = clientById(b.client_id), s = serviceById(b.service_id);
        const phone = c?.phone ? ` • ${c.phone}` : "";
        return `<option value="${b.id}">${new Date(b.start_at).toLocaleString()} • ${(c?.name||"Cliente")}${phone} • ${(s?.name||"Serviço")}</option>`;
      })
    ).join("");
  }

  $("f_useBooking").onclick = ()=>{
    const id = $("f_booking").value;
    if(!id) return toast("warn","Finalizar","Selecione um agendamento (ou finalize manual).");
    const b = CACHE.bookings.find(x=>x.id===id);
    if(!b) return;
    $("f_client").value = b.client_id || "";
    $("f_service").value = b.service_id || "";
    $("f_price").value = String(Number(b.expected_price||0).toFixed(2));
    $("f_cost").value  = String(Number(b.expected_cost||0).toFixed(2));
  };

  async function addLoyaltyPoints(client_id, points){
    const user = CACHE.user;
    if(!user || !client_id || !points) return;

    const { data: row, error } = await sb.from("loyalty")
      .select("id,points").eq("owner_id", user.id).eq("client_id", client_id).maybeSingle();
    if(error) return toast("err","Fidelidade", error.message);

    if(row?.id){
      await sb.from("loyalty")
        .update({ points: Number(row.points||0)+points, updated_at:new Date().toISOString() })
        .eq("id", row.id);
    }else{
      await sb.from("loyalty")
        .insert({ owner_id:user.id, client_id, points, updated_at:new Date().toISOString() });
    }
  }

  async function finalizeNow(){
    const user = CACHE.user;
    const booking_id = $("f_booking").value || null;
    const client_id = $("f_client").value || null;
    const service_id = $("f_service").value || null;
    const charged_price = num($("f_price").value);
    const material_cost = num($("f_cost").value);
    const payment_method = $("f_pay").value;
    const notes = $("f_notes").value.trim() || null;
    const points = parseInt($("f_points").value || "0", 10) || 0;

    if(!client_id) return toast("warn","Finalizar","Selecione o cliente.");
    if(!service_id) return toast("warn","Finalizar","Selecione o serviço.");

    const { error } = await sb.from("appointments").insert({
      owner_id:user.id, booking_id, client_id, service_id,
      done_at:new Date().toISOString(),
      charged_price, material_cost, payment_method, notes
    });
    if(error) return toast("err","Finalizar", error.message);

    if(booking_id) await sb.from("bookings").update({ status:"DONE" }).eq("id", booking_id);
    if(points>0) await addLoyaltyPoints(client_id, points);

    $("f_notes").value="";
    toast("ok","Finalizar","Atendimento registrado!");

    await loadBookings();
    await refreshFinalizeBookingSelect();
    renderBookingsList(CACHE.bookings);
    renderOnlineBookings();
    await renderDashboard();
    await renderLoyalty();
  }
  $("f_done").onclick = finalizeNow;

  async function renderLoyalty(){
    const user = CACHE.user;
    if(!user) return;

    const { data, error } = await sb.from("loyalty")
      .select("points, client_id, updated_at, clients(name, phone)")
      .eq("owner_id", user.id)
      .order("updated_at", { ascending:false });
    if(error) return toast("err","Fidelidade", error.message);

    const q = ($("l_search").value || "").toLowerCase();
    const rows = (data||[]).filter(r => (r.clients?.name||"").toLowerCase().includes(q));

    $("l_list").innerHTML = rows.map(r=>`
      <div class="item">
        <div><div class="t">${r.clients?.name || "Cliente"}</div><div class="m">${r.clients?.phone || "-"}</div></div>
        <div class="badge neon">${r.points || 0} pts</div>
      </div>
    `).join("") || `<div class="muted">Sem pontos cadastrados.</div>`;
  }
  $("l_search").oninput = renderLoyalty;

  async function refreshAll(){
    // 1) aplica sessão se veio do link
    await handleAuthRedirect();

    // 2) carrega usuário
    await loadUser();
    applyAuthUI(CACHE.user);

    if(!CACHE.user) return;

    if(!$("nav").dataset.ready){
      buildNav();
      $("nav").dataset.ready = "1";
    }

    const active = document.querySelector(".navbtn.active")?.dataset?.target || "dashSection";
    setPage(active);

    await loadClients();
    await loadServices();
    await loadBookings();

    fillClientSelect("b_client");
    fillClientSelect("f_client");
    fillServiceSelect("a_service");
    fillServiceSelect("b_service");
    fillServiceSelect("f_service");

    renderClients();
    renderServices();
    await renderAvailability();

    renderBookingsList(CACHE.bookings);
    renderOnlineBookings();
    await refreshFinalizeBookingSelect();
    await renderLoyalty();
    await renderDashboard();
  }

  // Primeira carga
  hideAllPages();
  refreshAll();
</script>
</body>
</html>
